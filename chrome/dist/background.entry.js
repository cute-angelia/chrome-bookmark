/*! Copyright banther@pm.me */!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}({0:function(e,t,n){"use strict";function r(){return new Promise((e,t)=>{try{chrome.storage.local.get(null,(function(n){var r=n.token||"",o=n.server||"";return""===r?t("no active session, please login first"):""===o?t("server url is not specified"):e({token:r,server:o})}))}catch(e){return t(e)}})}function o(){return new Promise((e,t)=>{try{chrome.tabs.query({active:!0,currentWindow:!0},n=>{!n||n.length;let r=n[0];null==r?t():e(r)})}catch(e){t(e)}})}function i(){chrome.tabs.create({url:"/view/options.html"})}function c(){return new Promise(e=>{var t="",n=chrome.runtime.getURL("/");if(n.startsWith("moz"))t="unfiled_____";else{if(!n.startsWith("chrome"))throw new Error("right now extension only support firefox and chrome");t="2"}chrome.bookmarks.getChildren(t,(function(n){var r=n.find(e=>null==e.url&&"Shiori"===e.title);if(r)return e(r);chrome.bookmarks.create({title:"Shiori",parentId:t},t=>e(t))}))})}function a(e){return new Promise(t=>{c().then(n=>{chrome.bookmarks.search({url:e},e=>{var r=e.findIndex(e=>e.parentId===n.id);return r>=0?t(e[r]):t()})})})}function s(e,t){return new Promise(n=>{c().then(r=>{chrome.bookmarks.search({url:e},o=>{-1===o.findIndex(e=>e.parentId===r.id)&&chrome.bookmarks.create({url:e,title:t,parentId:r.id},()=>{n()}),n()})})})}function u(e){return new Promise(t=>{c().then(n=>{chrome.bookmarks.search({url:e},e=>(e.forEach(e=>{e.parentId===n.id&&chrome.bookmarks.remove(e.id)}),t()))})})}function l(e,t){try{var n="posting_"+Math.random();chrome.notifications.create(n,{type:"basic",title:e,message:t,iconUrl:"/icons/icon.png"},(function(e){})),setTimeout((function(){chrome.notifications.clear(n,(function(e){}))}),5e3)}catch(e){alert(e.message)}}n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return o})),n.d(t,"e",(function(){return i})),n.d(t,"a",(function(){return a})),n.d(t,"g",(function(){return s})),n.d(t,"f",(function(){return u})),n.d(t,"d",(function(){return l}))},5:function(e,t,n){"use strict";n.r(t);var r=n(0);var o=new class{get(e,t={}){var n={};const r=new URLSearchParams;for(let e in t)r.append(e,t[e]);const o=r.toString();var i=new URL(e,baseUrl);return i=i+"?"+o,new Promise((function(e,t){""!=token&&(n.Authorization="Bearer "+token),fetch(i,{headers:n}).then(e=>e.json()).then(t=>e(t)).catch(e=>{t(e)})}))}post(e,t={},n={"Content-Type":"application/json"}){return new Promise((function(o,i){Object(r.c)().then(c=>{const a=c.token,s=c.server;var u=new URL(e,s);""!=a&&(n.Authorization="Bearer "+a);var l="";if(n["Content-Type"].indexOf("application/x-www-form-urlencoded")>=0){let e="";for(const n in t)e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n])+"&";l=e.substring(0,e.length-1)}else"multipart/form-data;charset=UTF-8"===n["Content-Type"]?l=t:(n["Content-Type"]="application/json",l=JSON.stringify(t));fetch(u,{method:"POST",credentials:"same-origin",headers:n,body:l}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(e=>o(e)).catch(e=>(Object(r.d)("通知","服务异常，无法访问服务:"+s),i(e)))}).catch(e=>i(e))}))}};function i(){var e,t;e=chrome.runtime.getURL("/"),t={path:{16:"icons/action-default-16.png",32:"icons/action-default-32.png",64:"icons/action-default-64.png"}},e.startsWith("moz")&&(t={}),Object(r.b)().then(e=>{Object(r.a)(e.url).then(e=>(e&&(t.path={16:"icons/action-bookmarked-16.png",32:"icons/action-bookmarked-32.png",64:"icons/action-bookmarked-64.png"}),chrome.browserAction.setIcon(t)))})}chrome.runtime.onMessage.addListener((e,t,n)=>{var i=Promise.resolve();switch(e.type){case"open-libraries":i=new Promise((e,t)=>{new Promise((function(e,t){Object(r.c)().then(t=>{chrome.tabs.create({active:!0,url:t.server}),e()}).catch(e=>{e.toString().includes("login")&&Object(r.e)(),t(e)})})).then(()=>{e()}).catch(e=>{t(e)})});break;case"remove-bookmark":i=new Promise((e,t)=>{new Promise((function(e,t){Object(r.b)().then(n=>{o.post("/api/bookmarks/deleteUrl",{url:n.url}).then(o=>0!=o.code?t(o.msg):(Object(r.f)(n.url),e())).catch(e=>{if(!e.toString().includes("login"))return t(e.toString());Object(r.e)()})})})).then(()=>{e()}).catch(e=>{t(e)})});break;case"save-bookmark":i=new Promise((t,n)=>{var i;(i=e.tags,new Promise((function(e,t){Object(r.b)().then(n=>{chrome.tabs.captureVisibleTab(null,{},(function(c){o.post("/api/bookmarks/add",{url:n.url,title:n.title,from:"ext",tags:i.join(","),imgbase64:c}).then(o=>0!=o.code?t(o.msg):(Object(r.g)(n.url,n.title),e())).catch(e=>{if(!e.toString().includes("login"))return t(e.toString());Object(r.e)()})}))})}))).then(()=>{t()}).catch(e=>{n(e)})})}return i}),chrome.bookmarks.onCreated.addListener(i),chrome.bookmarks.onRemoved.addListener(i),chrome.tabs.onUpdated.addListener(i),chrome.tabs.onActivated.addListener(i),chrome.windows.onFocusChanged.addListener(i),i()}});